{"version":3,"sources":["body_index_calculator/events.cljs"],"mappings":"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","names":["body-index-calculator.events/*trace-events*","body-index-calculator.events/check-and-throw","a-spec","db","cljs.spec.alpha.valid_QMARK_.cljs$core$IFn$_invoke$arity$2","cljs.core.ex_info.cljs$core$IFn$_invoke$arity$2","cljs.spec.alpha/explain-str","body-index-calculator.events/check-spec-after-interceptor","G__83473","re-frame.core/after","cljs.core.partial.cljs$core$IFn$_invoke$arity$2","body-index-calculator.events/common-interseptors","re-frame.core/debug","body-index-calculator.events/html-attr-interceptor","G__83475","p1__83474#","body-index-calculator.utils.lang/write-html-lang-attr!","re_frame.core.reg_event_db.cljs$core$IFn$_invoke$arity$3","_","body-index-calculator.db/default-db","p__83476","vec__83477","cljs.core.nth.cljs$core$IFn$_invoke$arity$3","new-theme","cljs.core.assoc.cljs$core$IFn$_invoke$arity$3","cljs.core.conj.cljs$core$IFn$_invoke$arity$2","p__83480","vec__83481","new-locale","p__83485","vec__83486","new-system","p1__83484#","cljs.core.update.cljs$core$IFn$_invoke$arity$3","body-index-calculator.helpers/convert-form-values","body-index-calculator.events/cond-field->metric","system","field","cljs.core._EQ_.cljs$core$IFn$_invoke$arity$2","body-index-calculator.helpers/convert-field-value","seq__83489","cljs.core/seq","chunk__83490","count__83491","i__83492","temp__5735__auto__","cljs.core/chunked-seq?","c__4550__auto__","cljs.core/chunk-first","cljs.core/chunk-rest","cljs.core/count","cljs.core/first","cljs.core/next","ev-name","path","cljs.core.keyword.cljs$core$IFn$_invoke$arity$1","cljs.core/name","p__83507","p__83508","map__83509","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply.cljs$core$IFn$_invoke$arity$2","cljs.core/hash-map","cljs.core.get.cljs$core$IFn$_invoke$arity$2","vec__83510","p__83514","p__83515","map__83516","vec__83517","form-field","cljs.core.update_in.cljs$core$IFn$_invoke$arity$3","db-field","cljs.core.merge.cljs$core$IFn$_invoke$arity$variadic","errors","body-index-calculator.validation/validate","js/body-index-calculator","js/body-index-calculator.events","js/body-index-calculator.events.timeouts","body-index-calculator.events/timeouts","reagent.core.atom.cljs$core$IFn$_invoke$arity$1","G__83521","G__83522","re-frame.core/reg-fx","p__83523","map__83524","id","event","time","temp__5739__auto__","existing","cljs.core/deref","js/clearTimeout","cljs.core.swap_BANG_.cljs$core$IFn$_invoke$arity$3","cljs.core/dissoc","cljs.core.swap_BANG_.cljs$core$IFn$_invoke$arity$4","cljs.core/assoc","js/setTimeout","re-frame.core/dispatch"],"sourcesContent":["(ns body-index-calculator.events\n  (:require\n   [cljs.spec.alpha :as s]\n   [reagent.core :as r]\n   [re-frame.core :as rf]\n   [body-index-calculator.utils.lang :as lang]\n   [body-index-calculator.validation :as validation]\n   [body-index-calculator.helpers :as helpers]\n   [body-index-calculator.db :as db]))\n\n(def ^:dynamic *trace-events* false)\n\n(defn check-and-throw\n  \"Throws an exception if `db` doesn't match the Spec `a-spec`.\"\n  [a-spec db]\n  (when-not (s/valid? a-spec db)\n    (throw (ex-info (str \"spec check failed: \" (s/explain-str a-spec db)) {}))))\n\n(def check-spec-after-interceptor (rf/after (partial check-and-throw ::db/db)))\n(def common-interseptors (if *trace-events*\n                           [rf/debug\n                            check-spec-after-interceptor]\n                           [check-spec-after-interceptor]))\n\n(def html-attr-interceptor\n  (rf/after #(lang/write-html-lang-attr! (:locale %))))\n\n(rf/reg-event-db\n ::init\n common-interseptors\n (fn [_ _] db/default-db))\n\n(rf/reg-event-db\n ::theme\n common-interseptors\n (fn [db [_ new-theme]]\n   (assoc db :theme new-theme)))\n\n(rf/reg-event-db\n ::locale\n (conj common-interseptors html-attr-interceptor)\n (fn [db [_ new-locale]]\n   (assoc db :locale new-locale)))\n\n(rf/reg-event-db\n ::system\n common-interseptors\n (fn [db [_ new-system]]\n   (-> db\n       (assoc :system new-system)\n       (update :form\n               #(helpers/convert-form-values new-system %)))))\n\n(defn cond-field->metric [system field]\n  (if (= :imperial system) (helpers/convert-field-value :metric field) field))\n\n(doseq [ev-name [::gender ::age\n                 ::weight ::height\n                 ::waist  ::hip]]\n  (let [path [:form (keyword (name ev-name))]]\n    (rf/reg-event-db\n     ev-name\n     common-interseptors\n     (fn [{:keys [system] :as db} [_ form-field]]\n       (update-in db path\n                  (fn [db-field]\n                    (let [field  (merge db-field form-field)\n                          errors (validation/validate (cond-field->metric system field))]\n                      (merge field errors))))))))\n\n(defonce timeouts (r/atom {}))\n\n(rf/reg-fx\n :timeout\n (fn [{:keys [id event time]}]\n   (when-some [existing (get @timeouts id)]\n     (js/clearTimeout existing)\n     (swap! timeouts dissoc id))\n   (when (some? event)\n     (swap! timeouts assoc id\n            (js/setTimeout\n             (fn []\n               (rf/dispatch event))\n             time)))))\n"]}